<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL v9.1 APEX ‚Äî Command Center</title>
    <meta name="description" content="Sentinel v9.1 APEX Trading Command Center ‚Äî Hybrid Intelligence Dashboard">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #09090b;
            --surface: #111113;
            --surface-2: #18181b;
            --border: #27272a;
            --border-accent: #3f3f46;
            --text: #fafafa;
            --text-2: #a1a1aa;
            --text-3: #71717a;
            --text-4: #52525b;
            --gold: #f59e0b;
            --gold-dim: rgba(245, 158, 11, 0.15);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.12);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.12);
            --blue: #3b82f6;
            --blue-dim: rgba(59, 130, 246, 0.12);
            --purple: #a855f7;
            --purple-dim: rgba(168, 85, 247, 0.12);
            --cyan: #06b6d4;
            --cyan-dim: rgba(6, 182, 212, 0.12);
            --radius: 12px;
            --radius-sm: 8px;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Layout */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 16px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        @media(max-width:768px) {

            .grid-2,
            .grid-3,
            .grid-5 {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media(max-width:480px) {

            .grid-2,
            .grid-3,
            .grid-5 {
                grid-template-columns: 1fr;
            }
        }

        /* Card */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .card-header {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-3);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header .icon {
            font-size: 14px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .header h1 span {
            color: var(--gold);
        }

        .version-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 100px;
            background: var(--gold-dim);
            color: var(--gold);
            border: 1px solid rgba(245, 158, 11, 0.25);
        }

        .status-area {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        /* Dot */
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }

        .dot-live {
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
        }

        .dot-poll {
            background: var(--gold);
            box-shadow: 0 0 6px var(--gold);
        }

        .dot-off {
            background: var(--red);
        }

        /* Metrics */
        .metric-value {
            font-size: 22px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.02em;
        }

        .metric-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-3);
            margin-bottom: 4px;
        }

        .metric-sub {
            font-size: 10px;
            color: var(--text-4);
            margin-top: 2px;
        }

        /* Colors */
        .c-green {
            color: var(--green);
        }

        .c-red {
            color: var(--red);
        }

        .c-gold {
            color: var(--gold);
        }

        .c-blue {
            color: var(--blue);
        }

        .c-purple {
            color: var(--purple);
        }

        .c-cyan {
            color: var(--cyan);
        }

        .c-dim {
            color: var(--text-3);
        }

        /* Tags */
        .tag {
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            display: inline-block;
        }

        .tag-green {
            background: var(--green-dim);
            color: var(--green);
        }

        .tag-red {
            background: var(--red-dim);
            color: var(--red);
        }

        .tag-blue {
            background: var(--blue-dim);
            color: var(--blue);
        }

        .tag-purple {
            background: var(--purple-dim);
            color: var(--purple);
        }

        .tag-gold {
            background: var(--gold-dim);
            color: var(--gold);
        }

        .tag-cyan {
            background: var(--cyan-dim);
            color: var(--cyan);
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            text-align: left;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-4);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 8px;
            border-bottom: 1px solid rgba(39, 39, 42, 0.5);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        /* Ring Progress */
        .ring {
            position: relative;
            width: 64px;
            height: 64px;
        }

        .ring svg {
            transform: rotate(-90deg);
        }

        .ring-value {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Hybrid Bar */
        .hybrid-bar {
            height: 6px;
            border-radius: 3px;
            background: var(--surface-2);
            overflow: hidden;
            margin-top: 6px;
        }

        .hybrid-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.6s ease;
        }

        /* Row item */
        .row-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
        }

        .row-item+.row-item {
            border-top: 1px solid rgba(39, 39, 42, 0.4);
        }

        .row-item .label {
            color: var(--text-3);
        }

        .row-item .value {
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        /* Animations */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.4
            }
        }

        @keyframes flash-g {
            0% {
                background: var(--green-dim)
            }

            100% {
                background: transparent
            }
        }

        @keyframes flash-r {
            0% {
                background: var(--red-dim)
            }

            100% {
                background: transparent
            }
        }

        .flash-up {
            animation: flash-g 0.8s ease-out;
        }

        .flash-down {
            animation: flash-r 0.8s ease-out;
        }

        .blink {
            animation: pulse 2s infinite;
        }

        /* Trade card */
        .trade-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            margin-bottom: 4px;
        }

        .trade-entry:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Open position card */
        .pos-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-bottom: 6px;
        }

        /* Intelligence panel */
        .intel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .intel-item {
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            padding: 10px;
            text-align: center;
        }

        .intel-item .val {
            font-size: 18px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .intel-item .lbl {
            font-size: 9px;
            color: var(--text-4);
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 16px 0;
            font-size: 10px;
            color: var(--text-4);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <h1>ü¶Ö <span>SENTINEL</span> <span class="version-badge">v9.1 APEX</span></h1>
                <p style="font-size:11px;color:var(--text-4);margin-top:2px;">Hybrid Intelligence ¬∑ Order Flow Scalper
                </p>
            </div>
            <div class="status-area">
                <div style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:500;">
                    <span id="conn-dot" class="dot dot-off"></span>
                    <span id="conn-label" class="c-dim">CONNECTING</span>
                </div>
                <div id="live-clock" class="mono" style="font-size:11px;color:var(--text-3);">--:--:--</div>
                <div id="last-update" style="font-size:9px;color:var(--text-4);">SYNCING...</div>
            </div>
        </div>

        <!-- TOP METRICS -->
        <div class="grid-5" style="margin-bottom:12px;">
            <div class="card" style="text-align:center;">
                <div class="metric-label">Balance</div>
                <div id="balance" class="metric-value c-gold">$15.00</div>
            </div>
            <div class="card" style="text-align:center;">
                <div class="metric-label">Total P&L</div>
                <div id="total-pnl" class="metric-value c-green">$0.00</div>
            </div>
            <div class="card" style="text-align:center;">
                <div class="metric-label">Win Rate</div>
                <div id="win-rate" class="metric-value c-blue">0%</div>
            </div>
            <div class="card" style="text-align:center;">
                <div class="metric-label">Trades</div>
                <div class="metric-value"><span id="wins" class="c-green">0</span><span class="c-dim">W</span> / <span
                        id="losses" class="c-red">0</span><span class="c-dim">L</span></div>
            </div>
            <div class="card" style="text-align:center;">
                <div class="metric-label">Session</div>
                <div id="session-status" class="metric-value" style="font-size:14px;">‚Äî</div>
            </div>
        </div>

        <!-- MAIN GRID: Market Radar + APEX Intelligence -->
        <div class="grid-2" style="grid-template-columns:2fr 1fr;margin-bottom:12px;">
            <!-- MARKET RADAR -->
            <div class="card">
                <div class="card-header"><span class="icon">üì°</span> Market Radar</div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th style="text-align:right">Price</th>
                                <th style="text-align:right">Œî%</th>
                                <th style="text-align:center">State</th>
                                <th style="text-align:center">RSI</th>
                                <th style="text-align:center">Signals</th>
                            </tr>
                        </thead>
                        <tbody id="market-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- APEX INTELLIGENCE -->
            <div class="card" style="border-color:rgba(245,158,11,0.2);">
                <div class="card-header" style="color:var(--gold);"><span class="icon">‚ö°</span> APEX Intelligence</div>
                <div class="intel-grid">
                    <div class="intel-item">
                        <div id="hybrid-score" class="val c-gold">‚Äî</div>
                        <div class="lbl">Hybrid Score</div>
                    </div>
                    <div class="intel-item">
                        <div id="ml-score" class="val c-purple">‚Äî</div>
                        <div class="lbl">ML Score</div>
                    </div>
                    <div class="intel-item">
                        <div id="div-status" class="val c-cyan" style="font-size:12px;">‚Äî</div>
                        <div class="lbl">Divergence</div>
                    </div>
                    <div class="intel-item">
                        <div id="lg-status" class="val c-blue" style="font-size:12px;">‚Äî</div>
                        <div class="lbl">Liquidity Grab</div>
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <div class="row-item"><span class="label">Strategy</span><span class="value c-gold">Triple-A +
                            VP</span></div>
                    <div class="row-item"><span class="label">AI Model</span><span class="value c-purple">Llama 3.3
                            70B</span></div>
                    <div class="row-item"><span class="label">Monte Carlo</span><span class="value c-blue"
                            id="mc-sims">120 sims</span></div>
                    <div class="row-item"><span class="label">Risk/Trade</span><span class="value c-green">0.5%</span>
                    </div>
                    <div class="row-item"><span class="label">Hybrid Min</span><span class="value c-gold">60%</span>
                    </div>
                    <div class="row-item"><span class="label">Snowball</span><span id="snowball-status"
                            class="value c-dim">1.0√ó</span></div>
                    <div class="row-item"><span class="label">Open Pos</span><span id="open-pos" class="value"
                            style="color:var(--text);">0</span></div>
                    <div class="row-item"><span class="label">Daily P&L</span><span id="daily-pnl"
                            class="value c-green">$0.00</span></div>
                </div>
            </div>
        </div>

        <!-- ROW 2: Open Positions + Trade History -->
        <div class="grid-2" style="margin-bottom:12px;">
            <div class="card">
                <div class="card-header"><span class="icon">üéØ</span> Open Positions</div>
                <div id="open-positions-list">
                    <p style="text-align:center;color:var(--text-4);font-size:12px;padding:20px 0;">Waiting for the
                        perfect setup...</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="icon">üìú</span> Trade History</div>
                <div id="trade-history" style="max-height:220px;overflow-y:auto;"></div>
            </div>
        </div>

        <!-- EQUITY CHART -->
        <div class="card" style="margin-bottom:12px;">
            <div class="card-header"><span class="icon">üìà</span> Equity Curve</div>
            <canvas id="equityChart" height="100"></canvas>
        </div>

        <!-- ROW 3: Auto-Learning + AI Reflection -->
        <div class="grid-2" style="margin-bottom:12px;">
            <div class="card">
                <div class="card-header"><span class="icon">üß¨</span> Auto-Learning Insights</div>
                <div id="learning-insights" style="font-size:12px;color:var(--text-3);">Loading patterns...</div>
            </div>
            <div class="card">
                <div class="card-header"><span class="icon">üß†</span> AI Valentini Reflection</div>
                <p id="ai-reflection" style="font-size:12px;color:var(--text-3);line-height:1.6;">Waiting for reflection
                    data...</p>
                <p id="reflection-time" style="font-size:9px;color:var(--text-4);margin-top:8px;"></p>
            </div>
        </div>

        <div class="footer">SENTINEL v9.1 APEX ‚Äî HYBRID INTELLIGENCE ¬∑ ORDER FLOW SCALPER ¬∑ CEREBRAS AI</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://udqxvsgdgxgtnhxxxcgv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkcXh2c2dkZ3hndG5oeHh4Y2d2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODcwNTM0NCwiZXhwIjoyMDg0MjgxMzQ0fQ.mUKPJvTeG2MU4Fxfddcbcx2Q7H8EDuXcDtWAbHGvT48';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let equityChart = null, realtimeConnected = false, lastBalanceVal = null, lastSuccessfulFetch = Date.now();
        const ASSETS = ['ORO', 'YEN', 'EURO', 'BITCOIN', 'ETHEREUM', 'SOLANA', 'BNB', 'NASDAQ100'];

        // ‚ïê‚ïê‚ïê Clock ‚ïê‚ïê‚ïê
        function tickClock() {
            const now = new Date();
            document.getElementById('live-clock').textContent = now.toLocaleTimeString() + ' ¬∑ UTC ' + now.toISOString().substring(11, 19);
            updateSession();
        }
        setInterval(tickClock, 1000); tickClock();

        function updateSession() {
            const h = new Date().getUTCHours();
            const el = document.getElementById('session-status');
            if (h >= 13 && h <= 16) { el.textContent = '‚ö° OVERLAP'; el.style.color = 'var(--gold)'; }
            else if (h >= 7 && h < 13) { el.textContent = 'üá¨üáß LONDON'; el.style.color = 'var(--blue)'; }
            else if (h > 16 && h <= 22) { el.textContent = 'üá∫üá∏ NEW YORK'; el.style.color = 'var(--green)'; }
            else { el.textContent = 'üîí CLOSED'; el.style.color = 'var(--text-4)'; el.style.fontSize = '12px'; }
        }

        // ‚ïê‚ïê‚ïê Connection ‚ïê‚ïê‚ïê
        function setConn(type) {
            const dot = document.getElementById('conn-dot'), lbl = document.getElementById('conn-label');
            if (type === 'live') { dot.className = 'dot dot-live'; lbl.textContent = 'REALTIME'; lbl.style.color = 'var(--green)'; realtimeConnected = true; }
            else if (type === 'poll') { dot.className = 'dot dot-poll'; lbl.textContent = 'POLLING'; lbl.style.color = 'var(--gold)'; realtimeConnected = false; }
            else { dot.className = 'dot dot-off'; lbl.textContent = 'OFFLINE'; lbl.style.color = 'var(--text-4)'; realtimeConnected = false; }
        }

        function flash(id, type) {
            const el = document.getElementById(id); if (!el) return;
            el.classList.remove('flash-up', 'flash-down'); void el.offsetWidth;
            el.classList.add(type === 'up' ? 'flash-up' : 'flash-down');
        }

        function tmo(promise, ms) { return Promise.race([promise, new Promise((_, r) => setTimeout(() => r(new Error('timeout')), ms))]); }

        // ‚ïê‚ïê‚ïê Portfolio ‚ïê‚ïê‚ïê
        async function fetchPortfolio() {
            const { data } = await tmo(sb.from('ghost_portfolio').select('*').order('id', { ascending: false }).limit(1), 8000);
            if (!data || !data[0]) return;
            const p = data[0], bal = parseFloat(p.balance), start = parseFloat(p.start_balance), pnl = bal - start;
            const wr = (p.wins + p.losses) > 0 ? ((p.wins / (p.wins + p.losses)) * 100).toFixed(1) : '0';
            if (lastBalanceVal !== null && bal !== lastBalanceVal) flash('balance', bal > lastBalanceVal ? 'up' : 'down');
            lastBalanceVal = bal;
            document.getElementById('balance').textContent = '$' + bal.toFixed(2);
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.textContent = (pnl >= 0 ? '+$' : '-$') + Math.abs(pnl).toFixed(2);
            pnlEl.className = 'metric-value ' + (pnl >= 0 ? 'c-green' : 'c-red');
            document.getElementById('win-rate').textContent = wr + '%';
            document.getElementById('wins').textContent = p.wins;
            document.getElementById('losses').textContent = p.losses;
        }

        // ‚ïê‚ïê‚ïê Trades ‚ïê‚ïê‚ïê
        async function fetchTrades() {
            const { data: open } = await tmo(sb.from('ghost_trades').select('*').eq('status', 'OPEN').order('opened_at', { ascending: false }), 8000);
            const openEl = document.getElementById('open-positions-list');
            document.getElementById('open-pos').textContent = open ? open.length : 0;
            if (open && open.length > 0) {
                openEl.innerHTML = open.map(t => {
                    const icon = t.direction === 'LONG' ? 'üü¢' : 'üî¥';
                    const tagCls = t.direction === 'LONG' ? 'tag-green' : 'tag-red';
                    const elapsed = Math.round((Date.now() - new Date(t.opened_at).getTime()) / 60000);
                    return `<div class="pos-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>${icon} <span class="tag ${tagCls}">${t.direction}</span> <strong style="margin-left:4px;">${t.asset}</strong></div>
                        <span class="mono" style="font-size:12px;">@ $${parseFloat(t.entry_price).toFixed(2)}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:10px;color:var(--text-4);">
                        <span>‚è± ${elapsed}min</span>
                        <span>${new Date(t.opened_at).toLocaleTimeString()}</span>
                    </div>
                </div>`;
                }).join('');
            } else {
                openEl.innerHTML = '<p style="text-align:center;color:var(--text-4);font-size:12px;padding:20px 0;">Waiting for the perfect setup...</p>';
            }

            const { data: closed } = await tmo(sb.from('ghost_trades').select('*').eq('status', 'CLOSED').order('closed_at', { ascending: false }).limit(20), 8000);
            const histEl = document.getElementById('trade-history');
            if (closed && closed.length > 0) {
                histEl.innerHTML = closed.map(t => {
                    const pnl = parseFloat(t.pnl);
                    const icon = pnl >= 0 ? 'üí∞' : 'üí∏';
                    return `<div class="trade-entry">
                    <div style="font-size:12px;">${icon} <span class="tag ${pnl >= 0 ? 'tag-green' : 'tag-red'}" style="margin-right:4px;">${t.direction}</span>${t.asset}</div>
                    <span class="mono ${pnl >= 0 ? 'c-green' : 'c-red'}" style="font-size:12px;font-weight:600;">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(4)}</span>
                </div>`;
                }).join('');
                const eq = [15]; closed.slice().reverse().forEach(t => eq.push(eq[eq.length - 1] + parseFloat(t.pnl)));
                renderEquity(eq);
            } else {
                histEl.innerHTML = '<p style="text-align:center;color:var(--text-4);font-size:12px;padding:20px 0;">No trades yet</p>';
            }
        }

        // ‚ïê‚ïê‚ïê Prices ‚ïê‚ïê‚ïê
        async function fetchPrices() {
            const { data } = await tmo(sb.from('ghost_prices').select('symbol, price, trend, momentum, volatility, recorded_at').order('recorded_at', { ascending: false }).limit(50), 8000);
            const latest = {};
            if (data) data.forEach(p => { if (!latest[p.symbol]) latest[p.symbol] = p; });
            document.getElementById('market-table').innerHTML = ASSETS.map(name => {
                const d = latest[name];
                if (!d) return `<tr><td style="color:var(--text-4)">${name}</td><td colspan="5" style="text-align:center;color:var(--text-4)">‚Äî</td></tr>`;
                const mom = parseFloat(d.momentum || 0), vol = parseFloat(d.volatility || 0);
                const momC = mom > 0 ? 'c-green' : mom < 0 ? 'c-red' : 'c-dim';
                let state = 'BALANCED', tagC = 'tag-blue';
                if (d.trend === 'FUERTE ALCISTA' || d.trend === 'EXPLORING_HIGH') { state = '‚Üë EXPLORING'; tagC = 'tag-green'; }
                else if (d.trend === 'FUERTE BAJISTA' || d.trend === 'EXPLORING_LOW') { state = '‚Üì EXPLORING'; tagC = 'tag-red'; }
                else if (d.trend === 'ALCISTA') { state = 'BULLISH'; tagC = 'tag-green'; }
                else if (d.trend === 'BAJISTA') { state = 'BEARISH'; tagC = 'tag-red'; }
                const rsi = Math.max(20, Math.min(80, 50 + mom * 10)).toFixed(0);
                const rc = rsi > 65 ? 'c-red' : rsi < 35 ? 'c-green' : 'c-dim';
                let sig = '';
                if (vol > 1.5) sig += '<span class="tag tag-red">‚ö°AGR</span> ';
                if (vol < 0.3 && vol > 0) sig += '<span class="tag tag-purple">üß≤ABS</span> ';
                return `<tr>
                <td style="font-weight:600;color:var(--text)">${name}</td>
                <td style="text-align:right" class="mono">$${parseFloat(d.price).toFixed(d.price > 100 ? 2 : 4)}</td>
                <td style="text-align:right" class="${momC} mono">${mom > 0 ? '+' : ''}${mom.toFixed(2)}%</td>
                <td style="text-align:center"><span class="tag ${tagC}">${state}</span></td>
                <td style="text-align:center" class="${rc} mono">${rsi}</td>
                <td style="text-align:center">${sig || '<span class="c-dim">‚Äî</span>'}</td>
            </tr>`;
            }).join('');
        }

        // ‚ïê‚ïê‚ïê Reflections & Learning ‚ïê‚ïê‚ïê
        async function fetchReflection() {
            const { data } = await tmo(sb.from('ghost_reflections').select('*').order('created_at', { ascending: false }).limit(1), 8000);
            if (data && data[0]) {
                document.getElementById('ai-reflection').textContent = data[0].analysis;
                document.getElementById('reflection-time').textContent = new Date(data[0].created_at).toLocaleString();
            }
        }

        async function fetchLearning() {
            const { data } = await tmo(sb.from('ghost_reflections').select('analysis, created_at').like('analysis', 'AUTO-LEARN:%').order('created_at', { ascending: false }).limit(5), 8000);
            const el = document.getElementById('learning-insights');
            if (data && data.length > 0) {
                el.innerHTML = data.map(d => {
                    const text = d.analysis.replace('AUTO-LEARN: ', '');
                    const won = text.includes('WIN');
                    return `<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:11px;">
                    <span class="tag ${won ? 'tag-green' : 'tag-red'}" style="margin-right:6px;">${won ? 'WIN' : 'LOSS'}</span>
                    <span style="color:var(--text-2);">${text.substring(0, 120)}</span>
                    <div style="font-size:9px;color:var(--text-4);margin-top:2px;">${new Date(d.created_at).toLocaleString()}</div>
                </div>`;
                }).join('');
            } else {
                el.innerHTML = '<p style="color:var(--text-4);font-size:11px;text-align:center;padding:12px;">No learning data yet ‚Äî patterns will appear after trades close</p>';
            }
        }

        // ‚ïê‚ïê‚ïê Equity Chart ‚ïê‚ïê‚ïê
        function renderEquity(data) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (equityChart) equityChart.destroy();
            const last = data[data.length - 1];
            const color = last >= 15 ? '#22c55e' : '#ef4444';
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i === 0 ? 'Start' : '#' + i),
                    datasets: [{ data, borderColor: color, backgroundColor: color + '15', fill: true, tension: 0.4, pointRadius: 1.5, borderWidth: 2, pointBackgroundColor: color }]
                },
                options: {
                    responsive: true, animation: { duration: 500 },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#52525b', font: { size: 10, family: "'JetBrains Mono'" }, callback: v => '$' + v.toFixed(2) } }
                    }
                }
            });
        }

        // ‚ïê‚ïê‚ïê Fetch All ‚ïê‚ïê‚ïê
        async function fetchAll() {
            try {
                const r = await Promise.allSettled([fetchPortfolio(), fetchTrades(), fetchPrices(), fetchReflection(), fetchLearning()]);
                const ok = r.filter(x => x.status === 'fulfilled').length;
                lastSuccessfulFetch = Date.now();
                document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString() + (ok < 5 ? ` (${ok}/5)` : '');
            } catch (e) {
                document.getElementById('last-update').textContent = 'Retrying...';
            }
            schedulePoll();
        }

        // ‚ïê‚ïê‚ïê Realtime ‚ïê‚ïê‚ïê
        function setupRealtime() {
            try {
                sb.channel('sentinel-apex')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'ghost_portfolio' }, () => fetchPortfolio().catch(() => { }))
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'ghost_trades' }, () => fetchTrades().catch(() => { }))
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ghost_prices' }, () => fetchPrices().catch(() => { }))
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ghost_reflections' }, () => { fetchReflection().catch(() => { }); fetchLearning().catch(() => { }); })
                    .subscribe(s => { if (s === 'SUBSCRIBED') setConn('live'); else if (s === 'CLOSED' || s === 'CHANNEL_ERROR') setConn('poll'); });
            } catch (e) { setConn('poll'); }
        }

        // ‚ïê‚ïê‚ïê Polling ‚ïê‚ïê‚ïê
        let pollTimer = null;
        function schedulePoll() {
            if (pollTimer) clearTimeout(pollTimer);
            const h = new Date().getUTCHours(), active = h >= 7 && h <= 22;
            pollTimer = setTimeout(fetchAll, realtimeConnected ? (active ? 10000 : 15000) : (active ? 5000 : 10000));
        }
        document.addEventListener('visibilitychange', () => { if (!document.hidden) fetchAll(); });
        setInterval(() => { if ((Date.now() - lastSuccessfulFetch) / 1000 > 30) fetchAll(); }, 30000);

        // ‚ïê‚ïê‚ïê Boot ‚ïê‚ïê‚ïê
        fetchAll();
        setupRealtime();
    </script>
</body>

</html>