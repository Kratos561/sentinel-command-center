<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL v9.0 ‚Äî VALENTINI COMMAND CENTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #030308;
            color: #c8ccd0;
        }

        .glass {
            background: rgba(12, 12, 20, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100, 130, 255, 0.12);
        }

        .glass-gold {
            background: rgba(12, 12, 20, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.25);
        }

        .neon-gold {
            text-shadow: 0 0 8px rgba(212, 175, 55, 0.6);
            color: #d4af37;
        }

        .neon-blue {
            text-shadow: 0 0 6px rgba(100, 130, 255, 0.5);
            color: #6482ff;
        }

        .grid-bg {
            background-image: radial-gradient(circle at 50% 50%, rgba(100, 130, 255, 0.03) 0%, transparent 70%), linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 24px 24px, 24px 24px;
        }

        .blink {
            animation: blinker 1.5s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0.3;
            }
        }

        @keyframes pulse-gold {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            }
        }

        .pulse-gold {
            animation: pulse-gold 2s ease-in-out infinite;
        }

        .kill-red {
            background: rgba(255, 50, 50, 0.15);
            border: 1px solid rgba(255, 50, 50, 0.4);
        }

        .kill-green {
            background: rgba(50, 255, 100, 0.1);
            border: 1px solid rgba(50, 255, 100, 0.3);
        }

        .badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .badge-absorb {
            background: rgba(147, 51, 234, 0.3);
            color: #c084fc;
            border: 1px solid rgba(147, 51, 234, 0.4);
        }

        .badge-aggr {
            background: rgba(249, 115, 22, 0.3);
            color: #fb923c;
            border: 1px solid rgba(249, 115, 22, 0.4);
        }

        .badge-value {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .badge-explore {
            background: rgba(16, 185, 129, 0.3);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        @keyframes flash-green {
            0% {
                background: rgba(52, 211, 153, 0.3);
            }

            100% {
                background: transparent;
            }
        }

        @keyframes flash-red {
            0% {
                background: rgba(248, 113, 113, 0.3);
            }

            100% {
                background: transparent;
            }
        }

        @keyframes flash-gold {
            0% {
                background: rgba(212, 175, 55, 0.25);
            }

            100% {
                background: transparent;
            }
        }

        .flash-up {
            animation: flash-green 0.8s ease-out;
        }

        .flash-down {
            animation: flash-red 0.8s ease-out;
        }

        .flash-update {
            animation: flash-gold 0.6s ease-out;
        }

        .conn-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .conn-live {
            background: #34d399;
            box-shadow: 0 0 6px #34d399;
        }

        .conn-poll {
            background: #fbbf24;
            box-shadow: 0 0 6px #fbbf24;
        }

        .conn-off {
            background: #f87171;
        }

        .live-badge {
            font-size: 0.55rem;
            padding: 1px 5px;
            border-radius: 3px;
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }
    </style>
</head>

<body class="grid-bg min-h-screen p-3 md:p-6">

    <!-- HEADER -->
    <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center glass-gold p-4 rounded-xl pulse-gold">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold neon-gold">ü¶Ö SENTINEL <span
                    class="text-xs text-gray-500 align-top">v9.0.2</span></h1>
            <p class="text-xs text-gray-500">VALENTINI UNLEASHED ‚Äî ORDER FLOW SCALPER</p>
        </div>
        <div class="text-right">
            <div id="system-status" class="text-emerald-400 font-bold flex items-center justify-end gap-2 text-sm">
                <span id="conn-indicator" class="conn-dot conn-off"></span>
                <span id="conn-label">CONNECTING</span>
                <span id="live-tag" class="live-badge" style="display:none">‚óè LIVE</span>
            </div>
            <p id="live-clock" class="text-xs text-gray-500 font-mono">--:--:--</p>
            <p id="last-update" class="text-[0.6rem] text-gray-700">SYNCING...</p>
        </div>
    </div>

    <!-- TOP METRICS ROW -->
    <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
        <div class="glass rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">BALANCE</p>
            <p id="balance" class="text-xl font-bold neon-gold">$15.00</p>
        </div>
        <div class="glass rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">P&L TOTAL</p>
            <p id="total-pnl" class="text-xl font-bold text-emerald-400">$0.00</p>
        </div>
        <div class="glass rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">WIN RATE</p>
            <p id="win-rate" class="text-xl font-bold neon-blue">0%</p>
        </div>
        <div class="glass rounded-lg p-3 text-center">
            <p class="text-xs text-gray-500">TRADES</p>
            <p id="total-trades" class="text-lg font-bold text-white"><span id="wins" class="text-emerald-400">0</span>W
                / <span id="losses" class="text-red-400">0</span>L</p>
        </div>
        <div id="kill-switch-card" class="glass rounded-lg p-3 text-center kill-green col-span-2 md:col-span-1">
            <p class="text-xs text-gray-500">KILL SWITCH</p>
            <p id="kill-switch" class="text-xl font-bold text-emerald-400">0/3</p>
            <p class="text-[0.6rem] text-gray-600">DAILY LOSSES</p>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

        <!-- MARKET RADAR -->
        <div class="glass rounded-xl p-4 md:col-span-2">
            <h2 class="text-sm font-bold text-gray-400 mb-3 flex items-center gap-2">üì° MARKET RADAR <span
                    class="badge badge-value">AUCTION THEORY</span></h2>
            <div class="overflow-x-auto scrollbar-hide">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="text-gray-600 border-b border-gray-800">
                            <th class="text-left py-2">ASSET</th>
                            <th class="text-right">PRICE</th>
                            <th class="text-right">Œî%</th>
                            <th class="text-center">MARKET STATE</th>
                            <th class="text-center">RSI</th>
                            <th class="text-center">SIGNALS</th>
                        </tr>
                    </thead>
                    <tbody id="market-table"></tbody>
                </table>
            </div>
        </div>

        <!-- VALENTINI STATUS -->
        <div class="glass-gold rounded-xl p-4">
            <h2 class="text-sm font-bold neon-gold mb-3">ü¶Ö VALENTINI STATUS</h2>
            <div class="space-y-3 text-xs">
                <div class="flex justify-between items-center"><span class="text-gray-500">Strategy</span><span
                        class="text-amber-300">Triple-A + VP</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">AI Model</span><span
                        class="text-purple-400">Llama 3.3 70B</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">Monte Carlo</span><span
                        id="mc-sims" class="text-blue-400">120 sims</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">Risk/Trade</span><span
                        class="text-emerald-400">0.5%</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">Session</span><span
                        id="session-status" class="text-emerald-400">‚Äî</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">NY Cooldown</span><span
                        id="ny-cooldown" class="text-gray-400">‚Äî</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">API Calls</span><span
                        id="api-calls" class="text-gray-400">‚Äî</span></div>
                <hr class="border-gray-800">
                <div class="flex justify-between items-center"><span class="text-gray-500">Open Positions</span><span
                        id="open-pos" class="text-white font-bold">0</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">Daily P&L</span><span
                        id="daily-pnl" class="text-emerald-400">$0.00</span></div>
                <div class="flex justify-between items-center"><span class="text-gray-500">Uptime</span><span
                        id="uptime" class="text-gray-400">‚Äî</span></div>
            </div>
        </div>
    </div>

    <!-- BOTTOM ROW -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- OPEN POSITIONS -->
        <div class="glass rounded-xl p-4">
            <h2 class="text-sm font-bold text-gray-400 mb-3">‚ö° OPEN POSITIONS</h2>
            <div id="open-positions-list" class="space-y-2 text-xs">
                <p class="text-gray-600 text-center py-4">No open positions</p>
            </div>
        </div>

        <!-- TRADE HISTORY -->
        <div class="glass rounded-xl p-4">
            <h2 class="text-sm font-bold text-gray-400 mb-3">üìú TRADE HISTORY</h2>
            <div id="trade-history" class="space-y-1.5 text-xs max-h-48 overflow-y-auto scrollbar-hide"></div>
        </div>
    </div>

    <!-- EQUITY CHART -->
    <div class="max-w-7xl mx-auto glass rounded-xl p-4 mb-4">
        <h2 class="text-sm font-bold text-gray-400 mb-3">üìà EQUITY CURVE</h2>
        <canvas id="equityChart" height="120"></canvas>
    </div>

    <!-- AI REFLECTION -->
    <div class="max-w-7xl mx-auto glass rounded-xl p-4">
        <h2 class="text-sm font-bold text-gray-400 mb-3">üß† AI VALENTINI REFLECTION</h2>
        <p id="ai-reflection" class="text-xs text-gray-500 leading-relaxed">Waiting for reflection data...</p>
        <p id="reflection-time" class="text-[0.6rem] text-gray-700 mt-2"></p>
    </div>

    <p class="text-center text-[0.6rem] text-gray-700 mt-6 mb-2">SENTINEL v9.0 VALENTINI EDITION ‚Äî ORDER FLOW SCALPER ‚Äî
        CEREBRAS AI</p>

    <script>
        const SUPABASE_URL = 'https://udqxvsgdgxgtnhxxxcgv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkcXh2c2dkZ3hndG5oeHh4Y2d2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODcwNTM0NCwiZXhwIjoyMDg0MjgxMzQ0fQ.mUKPJvTeG2MU4Fxfddcbcx2Q7H8EDuXcDtWAbHGvT48';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let equityChart = null;
        let realtimeConnected = false;
        let lastBalanceVal = null;
        let pollInterval = null;
        const ASSETS_LIST = ['ORO', 'YEN', 'EURO', 'BITCOIN', 'ETHEREUM', 'SOLANA', 'BNB', 'NASDAQ100'];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIVE CLOCK (1s) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function tickClock() {
            const now = new Date();
            const utc = now.toISOString().substring(11, 19);
            const local = now.toLocaleTimeString();
            document.getElementById('live-clock').textContent = `${local} | UTC ${utc}`;
            updateSessionDisplay();
        }
        setInterval(tickClock, 1000);
        tickClock();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SESSION DISPLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function updateSessionDisplay() {
            const h = new Date().getUTCHours(), m = new Date().getUTCMinutes();
            const isOverlap = h >= 13 && h <= 16;
            const isLondon = h >= 7 && h < 13;
            const isNY = h > 16 && h <= 22;
            const isActive = h >= 7 && h <= 22;
            let label = 'CLOSED', cls = 'text-red-400';
            if (isOverlap) { label = 'OVERLAP ‚ö°'; cls = 'text-amber-400 font-bold'; }
            else if (isLondon) { label = 'LONDON üá¨üáß'; cls = 'text-blue-400'; }
            else if (isNY) { label = 'NEW YORK üá∫üá∏'; cls = 'text-emerald-400'; }
            document.getElementById('session-status').textContent = label;
            document.getElementById('session-status').className = cls;
            // Cooldowns
            const londonCool = (h === 7 && m < 30);
            const nyCool = (h === 14 && m >= 30) || (h === 15 && m === 0);
            const coolEl = document.getElementById('ny-cooldown');
            if (londonCool) { coolEl.textContent = 'LONDON ‚è≥'; coolEl.className = 'text-blue-400'; }
            else if (nyCool) { coolEl.textContent = 'NY ‚è≥'; coolEl.className = 'text-amber-400'; }
            else { coolEl.textContent = 'OFF'; coolEl.className = 'text-gray-500'; }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONNECTION STATUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setConnection(type) {
            const dot = document.getElementById('conn-indicator');
            const lbl = document.getElementById('conn-label');
            const tag = document.getElementById('live-tag');
            if (type === 'live') { dot.className = 'conn-dot conn-live'; lbl.textContent = 'REALTIME'; tag.style.display = 'inline'; realtimeConnected = true; }
            else if (type === 'poll') { dot.className = 'conn-dot conn-poll'; lbl.textContent = 'POLLING'; tag.style.display = 'none'; realtimeConnected = false; }
            else { dot.className = 'conn-dot conn-off'; lbl.textContent = 'OFFLINE'; tag.style.display = 'none'; realtimeConnected = false; }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FLASH ANIMATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function flash(elementId, type) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.classList.remove('flash-up', 'flash-down', 'flash-update');
            void el.offsetWidth; // reflow
            el.classList.add(type === 'up' ? 'flash-up' : type === 'down' ? 'flash-down' : 'flash-update');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FETCH WITH TIMEOUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function withTimeout(promise, ms) {
            return Promise.race([promise, new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))]);
        }

        async function fetchPortfolio() {
            const { data } = await withTimeout(sb.from('ghost_portfolio').select('*').order('id', { ascending: false }).limit(1), 8000);
            if (!data || !data[0]) return;
            const p = data[0];
            const bal = parseFloat(p.balance), start = parseFloat(p.start_balance);
            const pnl = bal - start;
            const wr = (p.wins + p.losses) > 0 ? ((p.wins / (p.wins + p.losses)) * 100).toFixed(1) : '0';
            if (lastBalanceVal !== null && bal !== lastBalanceVal) flash('balance', bal > lastBalanceVal ? 'up' : 'down');
            lastBalanceVal = bal;
            document.getElementById('balance').textContent = '$' + bal.toFixed(2);
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.textContent = (pnl >= 0 ? '+$' : '-$') + Math.abs(pnl).toFixed(2);
            pnlEl.className = 'text-xl font-bold ' + (pnl >= 0 ? 'text-emerald-400' : 'text-red-400');
            document.getElementById('win-rate').textContent = wr + '%';
            document.getElementById('wins').textContent = p.wins;
            document.getElementById('losses').textContent = p.losses;
        }

        async function fetchTrades() {
            const { data: open } = await withTimeout(sb.from('ghost_trades').select('*').eq('status', 'OPEN').order('opened_at', { ascending: false }), 8000);
            const openEl = document.getElementById('open-positions-list');
            document.getElementById('open-pos').textContent = open ? open.length : 0;
            if (open && open.length > 0) {
                openEl.innerHTML = open.map(t => `<div class="flex justify-between items-center glass rounded-lg p-2">
                    <div>${t.direction === 'LONG' ? 'üü¢' : 'üî¥'} <span class="font-bold text-white">${t.direction}</span> ${t.asset}</div>
                    <div class="text-right"><span class="text-gray-400">@</span> $${parseFloat(t.entry_price).toFixed(2)}<br><span class="text-[0.6rem] text-gray-600">${new Date(t.opened_at).toLocaleString()}</span></div>
                </div>`).join('');
                flash('open-positions-list', 'update');
            } else { openEl.innerHTML = '<p class="text-gray-600 text-center py-4">Esperando el setup perfecto...</p>'; }
            const { data: closed } = await withTimeout(sb.from('ghost_trades').select('*').eq('status', 'CLOSED').order('closed_at', { ascending: false }).limit(15), 8000);
            const histEl = document.getElementById('trade-history');
            if (closed && closed.length > 0) {
                histEl.innerHTML = closed.map(t => {
                    const pnl = parseFloat(t.pnl);
                    return `<div class="flex justify-between items-center py-1 border-b border-gray-800/50">
                    <span>${pnl >= 0 ? 'üí∞' : 'üí∏'} ${t.direction} ${t.asset}</span>
                    <span class="${pnl >= 0 ? 'text-emerald-400' : 'text-red-400'} font-bold">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(4)}</span>
                </div>`;
                }).join('');
                const eq = [15]; closed.slice().reverse().forEach(t => eq.push(eq[eq.length - 1] + parseFloat(t.pnl)));
                renderEquityChart(eq);
            } else { histEl.innerHTML = '<p class="text-gray-600 text-center py-4">No trades yet</p>'; }
        }

        async function fetchPrices() {
            const { data } = await withTimeout(sb.from('ghost_prices').select('symbol, price, trend, momentum, volatility, recorded_at').order('recorded_at', { ascending: false }).limit(50), 8000);
            const latest = {};
            if (data) data.forEach(p => { if (!latest[p.symbol]) latest[p.symbol] = p; });
            const el = document.getElementById('market-table');
            el.innerHTML = ASSETS_LIST.map(name => {
                const d = latest[name];
                if (!d) return `<tr class="border-b border-gray-800/30"><td class="py-1.5 text-gray-600">${name}</td><td colspan="5" class="text-center text-gray-700">‚Äî</td></tr>`;
                const mom = parseFloat(d.momentum || 0), vol = parseFloat(d.volatility || 0);
                const momColor = mom > 0 ? 'text-emerald-400' : mom < 0 ? 'text-red-400' : 'text-gray-500';
                let state = 'BALANCED', sb2 = 'badge-value';
                if (d.trend === 'FUERTE ALCISTA' || d.trend === 'EXPLORING_HIGH') { state = 'EXPLORING ‚Üë'; sb2 = 'badge-explore'; }
                else if (d.trend === 'FUERTE BAJISTA' || d.trend === 'EXPLORING_LOW') { state = 'EXPLORING ‚Üì'; sb2 = 'badge-aggr'; }
                else if (d.trend === 'ALCISTA') { state = 'BULLISH'; sb2 = 'badge-explore'; }
                else if (d.trend === 'BAJISTA') { state = 'BEARISH'; sb2 = 'badge-aggr'; }
                const rsi = Math.max(20, Math.min(80, 50 + mom * 10)).toFixed(0);
                const rc = rsi > 65 ? 'text-red-400' : rsi < 35 ? 'text-emerald-400' : 'text-gray-400';
                let sig = '';
                if (vol > 1.5) sig += '<span class="badge badge-aggr">‚ö°AGR</span> ';
                if (vol < 0.3 && vol > 0) sig += '<span class="badge badge-absorb">üß≤ABS</span> ';
                return `<tr class="border-b border-gray-800/30 hover:bg-white/5">
                <td class="py-1.5 font-bold text-white">${name}</td>
                <td class="text-right text-gray-300">$${parseFloat(d.price).toFixed(d.price > 100 ? 2 : 4)}</td>
                <td class="text-right ${momColor}">${mom > 0 ? '+' : ''}${mom.toFixed(2)}%</td>
                <td class="text-center"><span class="badge ${sb2}">${state}</span></td>
                <td class="text-center ${rc}">${rsi}</td>
                <td class="text-center">${sig || '<span class="text-gray-700">‚Äî</span>'}</td></tr>`;
            }).join('');
        }

        async function fetchReflection() {
            const { data } = await withTimeout(sb.from('ghost_reflections').select('*').order('created_at', { ascending: false }).limit(1), 8000);
            if (data && data[0]) {
                document.getElementById('ai-reflection').textContent = data[0].analysis;
                document.getElementById('reflection-time').textContent = 'Last: ' + new Date(data[0].created_at).toLocaleString();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESILIENT FETCH ALL (Promise.allSettled) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let lastSuccessfulFetch = Date.now();
        async function fetchAll() {
            try {
                const results = await Promise.allSettled([fetchPortfolio(), fetchTrades(), fetchPrices(), fetchReflection()]);
                const ok = results.filter(r => r.status === 'fulfilled').length;
                const fail = results.filter(r => r.status === 'rejected').length;
                lastSuccessfulFetch = Date.now();
                if (fail > 0) {
                    document.getElementById('last-update').textContent = `Updated: ${new Date().toLocaleTimeString()} (${ok}/4 OK)`;
                } else {
                    document.getElementById('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                }
            } catch (e) {
                document.getElementById('last-update').textContent = 'Retry... ' + new Date().toLocaleTimeString();
            }
            schedulePoll(); // always schedule next poll
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUPABASE REALTIME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setupRealtime() {
            try {
                sb.channel('sentinel-live')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'ghost_portfolio' }, () => { fetchPortfolio().catch(() => { }); flash('balance', 'update'); })
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'ghost_trades' }, () => { fetchTrades().catch(() => { }); flash('trade-history', 'update'); })
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ghost_prices' }, () => { fetchPrices().catch(() => { }); })
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ghost_reflections' }, () => { fetchReflection().catch(() => { }); flash('ai-reflection', 'update'); })
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') { setConnection('live'); }
                        else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') { setConnection('poll'); }
                    });
            } catch (e) { setConnection('poll'); }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECURSIVE POLLING (never hangs) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let pollTimer = null;
        function getInterval() {
            const h = new Date().getUTCHours();
            const isActive = h >= 7 && h <= 22;
            if (realtimeConnected) return isActive ? 10000 : 15000;
            return isActive ? 5000 : 10000;
        }
        function schedulePoll() {
            if (pollTimer) clearTimeout(pollTimer);
            pollTimer = setTimeout(fetchAll, getInterval());
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB FOCUS: Re-fetch immediately ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                fetchAll();
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STALE DATA WATCHDOG (every 30s) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        setInterval(() => {
            const staleSec = (Date.now() - lastSuccessfulFetch) / 1000;
            if (staleSec > 30) {
                document.getElementById('last-update').textContent = 'Reconnecting...';
                fetchAll();
            }
        }, 30000);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EQUITY CHART ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderEquityChart(data) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (equityChart) equityChart.destroy();
            const last = data[data.length - 1];
            const c = last >= 15 ? 'rgba(52,211,153,' : 'rgba(248,113,113,';
            equityChart = new Chart(ctx, {
                type: 'line',
                data: { labels: data.map((_, i) => i === 0 ? 'Start' : '#' + i), datasets: [{ data, borderColor: c + '1)', backgroundColor: c + '0.1)', fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2 }] },
                options: { responsive: true, animation: { duration: 600 }, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#555', callback: v => '$' + v.toFixed(2) } } } }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        fetchAll();
        setupRealtime();
    </script>
</body>

</html>